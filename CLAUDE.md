# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a static lab website for Takami Lab that publishes to GitHub Pages and auto-syncs research achievements from researchmap WebAPI. The site is built with vanilla JavaScript (no build tools) and displays publications, talks, projects, and awards.

## Commands

### Local Development
```bash
# Start local server for preview
python3 -m http.server 8000
# Then open http://localhost:8000
```

### Fetch researchmap Data
```bash
# Run the researchmap data fetcher (Node.js required)
node scripts/fetch_researchmap.mjs
```

This script:
- Reads `site.config.json` for the researchmap permalink and API settings
- Fetches data from the researchmap WebAPI
- Writes cached JSON files to `data/researchmap/` directory
- Should be run manually or via GitHub Actions on a schedule

## Architecture

### Data Flow: Two-Tier System

The site uses a **cache-first + live-fallback** strategy:

1. **GitHub Actions Cache (Primary)**
   - `scripts/fetch_researchmap.mjs` fetches from researchmap API periodically
   - Writes static JSON files to `data/researchmap/{type}.json`
   - These files are committed and served with the static site
   - Metadata stored in `data/researchmap/meta.json`

2. **Browser Live Fetch (Fallback)**
   - `assets/researchmap.js` provides `fetchLiveData()` function
   - Attempts direct API calls from the browser if user clicks "refresh"
   - May fail due to CORS/network issues—silently falls back to cache
   - Uses pagination with automatic start-index detection (0 or 1)

### File Structure

```
.
├── index.html              # Single-page site structure
├── site.config.json        # Lab info + researchmap settings
├── assets/
│   ├── app.js             # Main UI logic: rendering, filtering, theme
│   ├── researchmap.js     # Data loading & normalization utilities
│   └── styles.css         # All styles (theme toggle support)
├── data/
│   └── researchmap/       # Cached JSON (generated by script or Actions)
│       ├── meta.json
│       ├── published_papers.json
│       ├── presentations.json
│       ├── research_projects.json
│       └── awards.json
└── scripts/
    └── fetch_researchmap.mjs  # Node script for pre-fetching data
```

### Key Modules

**`assets/app.js`**
- Orchestrates UI: reads config, loads cached data, renders sections
- Implements search/filter for publications by title/venue/year
- Handles theme toggle (light/dark) with localStorage persistence
- Exports JSON functionality for publications

**`assets/researchmap.js`**
- `loadConfig()`: fetches `site.config.json`
- `loadCachedData()`: reads pre-generated JSON from `data/researchmap/`
- `fetchLiveData()`: attempts live API fetch (best-effort)
- `normalizeItems()`: defensive normalization of API responses (fields vary by type)

**`scripts/fetch_researchmap.mjs`**
- Standalone Node.js script for data sync
- Pagination logic handles both 0-based and 1-based start indices
- Writes cache files + metadata for GitHub Pages deployment

### Configuration: `site.config.json`

This file drives all site content and API behavior:

```json
{
  "lab": {
    "name_ja": "...",
    "name_en": "...",
    "tagline": "...",
    "affiliation": "...",
    "email": "...",
    "social": { "researchmap": "...", "orcid": "...", "github": "..." }
  },
  "researchmap": {
    "permalink": "takamikyo",        // REQUIRED for API calls
    "baseUrl": "https://api.researchmap.jp",
    "types": ["published_papers", "presentations", "research_projects", "awards"]
  },
  "ui": {
    "maxItemsPerSection": 50
  }
}
```

### researchmap API Integration

The researchmap WebAPI is used to fetch achievements. Key points:

- **Endpoint pattern**: `{baseUrl}/{permalink}/{type}?format=json&limit=1000&start={N}`
- **Types supported**: `published_papers`, `presentations`, `research_projects`, `awards`
- **Pagination quirk**: Start index may be 0 or 1 depending on API behavior—both scripts auto-detect
- **Field variance**: API responses have inconsistent field names; `normalizeItems()` handles defensively
- **CORS limitation**: Direct browser fetch may fail; cache is essential for reliability

### Theme System

- CSS custom properties define light/dark themes
- `<html class="light">` toggles theme
- localStorage persists user preference
- Defaults to system preference (`prefers-color-scheme`)

## Development Notes

### When Modifying UI
- All HTML is in `index.html` (single-page structure)
- Dynamic content is rendered by `app.js` from JSON data
- Avoid inline styles; use `styles.css` classes

### When Adding New Data Types
1. Add the type to `site.config.json` → `researchmap.types[]`
2. Update `normalizeItems()` in `assets/researchmap.js` to handle new fields
3. Add rendering logic in `app.js`
4. Run `node scripts/fetch_researchmap.mjs` to fetch and cache

### When Debugging Data Issues
- Check `data/researchmap/meta.json` for fetch timestamp and status
- Inspect raw API responses via `{item}.raw` in normalized data
- Test live fetch by clicking "researchmapから再取得" button
- Use browser DevTools Network tab to inspect API calls

### GitHub Pages Deployment
- No build step required (vanilla JS)
- Enable Pages: Settings → Pages → Deploy from branch `main` / `/ (root)`
- Optionally set up GitHub Actions workflow to run `fetch_researchmap.mjs` daily

## Important Constraints

- **No package.json**: This is intentionally dependency-free for simplicity
- **No transpilation**: Code must work in modern browsers without bundling
- **Static-only**: All dynamic behavior happens client-side
- **CORS-aware**: Browser API calls may fail; design for graceful fallback
